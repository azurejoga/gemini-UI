name: BNVD Security Sync

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      severity_filter:
        description: "Filtrar por severidade mínima"
        required: false
        default: "ALL"
        type: choice
        options:
          - ALL
          - CRITICAL
          - HIGH
          - MEDIUM
          - LOW
      fail_on_critical:
        description: "Falhar se encontrar vulnerabilidades críticas"
        required: false
        default: false
        type: boolean
      fail_on_high:
        description: "Falhar se encontrar vulnerabilidades high ou superiores"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  security-events: read
  issues: read
  pull-requests: read

jobs:
  security-scan:
    name: Scan e Enriquecimento BNVD
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: read
      issues: read
      pull-requests: read
    
    outputs:
      total_cves: ${{ steps.bnvd.outputs.total_cves_found }}
      critical_count: ${{ steps.bnvd.outputs.critical_count }}
      high_count: ${{ steps.bnvd.outputs.high_count }}
      has_critical: ${{ steps.bnvd.outputs.has_critical }}
      has_high: ${{ steps.bnvd.outputs.has_high }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Debug - Check Security Alerts Access
        continue-on-error: true
        run: |
          echo "::group::Verificando acesso aos alertas de segurança"
          
          # Verificar Dependabot
          echo "=== Tentando acessar alertas Dependabot ==="
          DEPENDABOT_RESPONSE=$(curl -s -w "\n%{http_code}" \
               -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/${{ github.repository }}/dependabot/alerts")
          
          HTTP_CODE=$(echo "$DEPENDABOT_RESPONSE" | tail -n1)
          BODY=$(echo "$DEPENDABOT_RESPONSE" | sed '$d')
          
          echo "Status HTTP: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            ALERT_COUNT=$(echo "$BODY" | jq 'length // 0')
            echo "Total de alertas: $ALERT_COUNT"
            if [ "$ALERT_COUNT" -gt 0 ]; then
              echo "Primeiro alerta:"
              echo "$BODY" | jq '.[0] | {number, state, cve: .security_advisory.cve_id, severity: .security_advisory.severity}'
            else
              echo "Nenhum alerta Dependabot encontrado"
            fi
          else
            echo "Erro ao acessar Dependabot:"
            echo "$BODY" | jq -r '.message // .'
          fi
          
          echo ""
          echo "=== Tentando acessar alertas Code Scanning ==="
          CODEQL_RESPONSE=$(curl -s -w "\n%{http_code}" \
               -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts")
          
          HTTP_CODE=$(echo "$CODEQL_RESPONSE" | tail -n1)
          BODY=$(echo "$CODEQL_RESPONSE" | sed '$d')
          
          echo "Status HTTP: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            ALERT_COUNT=$(echo "$BODY" | jq 'length // 0')
            echo "Total de alertas: $ALERT_COUNT"
            if [ "$ALERT_COUNT" -gt 0 ]; then
              echo "Primeiro alerta:"
              echo "$BODY" | jq '.[0] | {number, state, rule_id: .rule.id, severity: .rule.security_severity_level, tags: .rule.tags}'
            else
              echo "Nenhum alerta Code Scanning encontrado"
            fi
          else
            echo "Erro ao acessar Code Scanning:"
            echo "$BODY" | jq -r '.message // .'
          fi
          
          echo "::endgroup::"

      - name: Run BNVD Security Enricher (Local Action)
        id: bnvd
        uses: ./.github/actions/bnvd-security-enricher
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dependabot_token: ${{ secrets.DEPENDABOT_PAT }}
          include_cwe_only: "true"
          bnvd_api_url: "https://bnvd.org/api/v1"
          nvd_api_key: ${{ secrets.NVD_API_KEY }}
          include_pt: "true"
          severity_filter: ${{ github.event.inputs.severity_filter || 'ALL' }}
          fail_on_critical: ${{ github.event.inputs.fail_on_critical || 'false' }}
          fail_on_high: ${{ github.event.inputs.fail_on_high || 'false' }}
          output_format: "both"
          max_concurrent_requests: "5"
          request_timeout: "30"
          retry_attempts: "3"

      - name: Upload JSON Report
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8
        with:
          name: bnvd-security-report-json
          path: bnvd-security-report.json
          retention-days: 90
          if-no-files-found: warn

      - name: Upload Markdown Report
        if: always()
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8
        with:
          name: bnvd-security-report-md
          path: bnvd-security-report.md
          retention-days: 90
          if-no-files-found: warn

      - name: Display Summary
        if: always()
        run: |
          echo "## BNVD Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:-------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total CVEs | ${{ steps.bnvd.outputs.total_cves_found }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enriched | ${{ steps.bnvd.outputs.total_enriched }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${{ steps.bnvd.outputs.critical_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${{ steps.bnvd.outputs.high_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | ${{ steps.bnvd.outputs.medium_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | ${{ steps.bnvd.outputs.low_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Execution Time | ${{ steps.bnvd.outputs.execution_time }}s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f bnvd-security-report.md ]; then
            echo "### Detailed Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat bnvd-security-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for Critical Vulnerabilities
        if: github.event.inputs.fail_on_critical == 'true' && steps.bnvd.outputs.has_critical == 'true'
        run: |
          echo "::error::Vulnerabilidades CRÍTICAS encontradas! Total: ${{ steps.bnvd.outputs.critical_count }}"
          exit 1

      - name: Check for High Vulnerabilities
        if: github.event.inputs.fail_on_high == 'true' && steps.bnvd.outputs.has_high == 'true'
        run: |
          echo "::error::Vulnerabilidades HIGH ou superiores encontradas!"
          exit 1

  notify:
    name: Notificação (Opcional)
    needs: security-scan
    runs-on: ubuntu-latest
    if: always() && needs.security-scan.outputs.has_critical == 'true'
    
    steps:
      - name: Critical Vulnerability Alert
        run: |
          echo "::warning::${{ needs.security-scan.outputs.critical_count }} vulnerabilidades críticas detectadas no repositório!"
          echo "Por favor, revise o relatório de segurança e tome as ações necessárias."
